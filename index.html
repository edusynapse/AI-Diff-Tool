<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self'; script-src 'self' 'unsafe-eval';">
  <title>AI Diff Tool - Grok 4 Patch Applier</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="node_modules/diff2html/bundles/css/diff2html.min.css">
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar" aria-label="Workspaces">
  <!-- Fixed topbar -->
  <div class="sidebar-topbar">
    <div class="sidebar-title">Workspaces</div>
    <button
      id="newTabBtn"
      class="topbar-btn topbar-btn--sidebar"
      type="button"
      title="New tab"
      aria-label="New tab"
    >+</button>
  </div>

  <!-- Scrollable area -->
  <div class="sidebar-scroll">
    <div id="tabsList" class="tabs-list" role="tablist" aria-orientation="vertical"></div>

    <div class="sidebar-footer">
      <div class="sidebar-hint">Double-click a tab to rename</div>
    </div>
  </div>
</aside>

    <main class="main">
  <!-- Fixed topbar (same height as sidebar topbar) -->
  <div class="main-topbar">
  <div class="main-title">AI Diff Tool</div>

  <div class="main-topbar-actions">
    <button id="diffPrevBtn" class="topbar-btn topbar-btn--nav hidden" type="button" title="Previous change">
      Prev change
    </button>
    <button id="diffNextBtn" class="topbar-btn topbar-btn--nav hidden" type="button" title="Next change">
      Next change
    </button>

    <!-- Appears only after scrolling down -->
    <button id="goTopBtn" class="topbar-btn topbar-btn--main hidden" type="button">
      Go to top
    </button>
  </div>
</div>

  <!-- Scrollable body -->
  <div id="mainScroll" class="main-body">
    <!-- REMOVE the old <h1> entirely (per your request) -->

    <!-- Model selector (per-tab state handled in renderer.js) -->
    <label for="modelSelect">Select Model:</label>
    <select id="modelSelect">
      <optgroup label="xAI">
        <option value="grok-4-1-fast-reasoning">grok-4-1-fast-reasoning</option>
        <option value="grok-4-1-fast-non-reasoning">grok-4-1-fast-non-reasoning</option>
        <option value="grok-code-fast-1">grok-code-fast-1</option>
        <option value="grok-4-fast-reasoning">grok-4-fast-reasoning</option>
        <option value="grok-4-fast-non-reasoning">grok-4-fast-non-reasoning</option>
      </optgroup>
      <optgroup label="OpenAI">
        <option value="gpt-4.1-mini">gpt-4.1-mini</option>
        <option value="gpt-4.1-nano">gpt-4.1-nano</option>
        <option value="gpt-5.2-mini">gpt-5.2-mini</option>
        <option value="gpt-5.2-nano">gpt-5.2-nano</option>
      </optgroup>
    </select>

    <label for="diff">Diff Patch (paste or load file):</label>
    <div class="ta-container">
      <div class="ta-actions" aria-label="Diff textarea actions">
        <button type="button" class="ta-fab" data-ta-action="max" data-ta-target="#diff" title="Maximize" aria-label="Maximize">â›¶</button>
        <button type="button" class="ta-fab" data-ta-action="min" data-ta-target="#diff" title="Minimize" aria-label="Minimize">ðŸ—•</button>
      </div>
      <textarea id="diff" rows="10"></textarea>
    </div>
    <input type="file" id="diffFile">

    <label for="model">File Content (paste or load file):</label>
    <div class="ta-container">
      <div class="ta-actions" aria-label="File content textarea actions">
        <button type="button" class="ta-fab" data-ta-action="max" data-ta-target="#model" title="Maximize" aria-label="Maximize">â›¶</button>
        <button type="button" class="ta-fab" data-ta-action="min" data-ta-target="#model" title="Minimize" aria-label="Minimize">ðŸ—•</button>
      </div>
      <textarea id="model" rows="15"></textarea>
    </div>
    <input type="file" id="modelFile">

    <button id="applyBtn">Apply Patch with Grok 4 Fast</button>
    <button id="retryBtn" class="hidden">Retry</button>

    <div id="loading" class="hidden"><div class="spinner"></div> Processing...</div>

    <div id="output-container" class="ta-container">
      <div class="ta-actions" aria-label="Output actions">
        <button type="button" class="ta-fab" data-ta-action="max" data-ta-target="#output" title="Maximize" aria-label="Maximize">â›¶</button>
        <button type="button" class="ta-fab" data-ta-action="min" data-ta-target="#output" title="Minimize" aria-label="Minimize">ðŸ—•</button>
        <!-- In output: max/min MUST precede Copy -->
        <button id="copyBtn" class="ta-copy hidden" type="button">Copy</button>
      </div>
      <pre id="output"></pre>
    </div>

    <button id="download" class="hidden">Download Modified File</button>
    <div id="diffView"></div>
    <div id="error"></div>
  </div>
</main>
  </div>

  <!-- Help overlay (opened from Help menu) -->
  <div id="helpOverlay" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="helpTitle">AI Diff Tool â€” Usage</h2>
        <button id="helpCloseBtn" class="modal-close" aria-label="Close help">Ã—</button>
      </div>

      <div class="modal-body">
        <p>
          This app applies a <b>unified diff patch</b> to a file by asking the selected Grok model to produce the patched output.
          It then shows you the modified file and a side-by-side diff view.
        </p>

        <h3>Quick steps</h3>
        <ol>
          <li><b>Select Model</b> (top dropdown).</li>
          <li><b>Paste or load</b> your unified diff patch into <b>Diff Patch</b>.</li>
          <li><b>Paste or load</b> the original file content into <b>File Content</b>.</li>
          <li>Enter your <b>API Key</b> (xAI or OpenAI), click <b>Save</b> (saved locally, encrypted).</li>
          <li>Click <b>Apply Patch</b>.</li>
          <li>Use <b>Copy</b> or <b>Download Modified File</b> once output is generated.</li>
        </ol>

        <h3>Notes</h3>
        <ul>
          <li>The model is instructed to output <b>only the final file contents</b> (no code fences, no commentary).</li>
          <li>If the file is large, you may get a size warning before sending.</li>
          <li><b>Dark Mode</b> can be toggled via the <b>View â†’ Dark Mode</b> menu item (or <b>Cmd/Ctrl + D</b>).</li>
          <li>You can dismiss this help with <b>ESC</b>, the <b>Ã—</b> button, or by clicking the background.</li>
        </ul>

        <h3>Keyboard shortcuts</h3>
        <ul>
          <li><b>F1</b>: Open Usage Help</li>
          <li><b>Cmd/Ctrl + D</b>: Toggle Dark Mode</li>
          <li><b>ESC</b>: Close Help</li>
        </ul>
      </div>

      <div class="modal-footer">
        <button id="helpOkBtn" class="modal-ok">Close</button>
      </div>
    </div>
  </div>
  <!-- Key Type overlay (shown ONLY when no keys exist at all) -->
  <div id="keyTypeOverlay" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="keyTypeTitle">
    <div class="modal-content modal-sm" role="document">
      <div class="modal-header">
        <h2 id="keyTypeTitle">Choose API Key Type</h2>
      </div>

      <div class="modal-body">
        <p id="keyTypeIntro">
          No API keys are saved yet. Choose which provider you want to configure first.
          Youâ€™ll set a <b>6-digit PIN</b> once, and it will be used to encrypt/decrypt keys locally.
        </p>
        <div id="keyTypeHint" class="modal-hint"></div>
      </div>

      <div class="modal-footer" style="justify-content: space-between;">
        <button id="keyTypeXaiBtn" class="modal-ok" type="button">xAI</button>
        <button id="keyTypeOpenAiBtn" class="modal-ok" type="button">OpenAI</button>
      </div>
    </div>
  </div>

  <!-- API Key overlay (opened from menu, or when required) -->
  <div id="apiKeyOverlay" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="apiKeyTitle">
    <div class="modal-content" role="document">
      <div class="modal-header">
        <h2 id="apiKeyTitle">API Key</h2>
        <button id="apiKeyCloseBtn" class="modal-close" aria-label="Close API key dialog">Ã—</button>
      </div>

      <div class="modal-body">
        <p id="apiKeyModalIntro">
          Enter your <b>API Key</b> and a <b>6-digit PIN</b>. The key is encrypted locally and stored in this app (localStorage).
          The PIN is not stored â€” youâ€™ll be asked for it on app launch to unlock saved keys.
        </p>

        <label id="apiKeyModalLabel" for="apiKeyModalInput">API Key</label>
        <input type="password" id="apiKeyModalInput" placeholder="sk-..." autocomplete="off">

        <label id="apiKeyPinLabel">6-digit PIN</label>
        <div id="apiKeyPinBoxes" class="pin-boxes" role="group" aria-labelledby="apiKeyPinLabel">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 1" autocomplete="off">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 2" autocomplete="off">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 3" autocomplete="off">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 4" autocomplete="off">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 5" autocomplete="off">
          <input class="pin-box" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" aria-label="PIN digit 6" autocomplete="off">
        </div>
        <!-- hidden aggregator (JS keeps this in sync with the 6 boxes) -->
        <input type="password" id="apiKeyPinInput" class="hidden" inputmode="numeric" maxlength="6" autocomplete="off">

        <div id="apiKeyModalHint" class="modal-hint"></div>
      </div>

      <div class="modal-footer">
        <button id="apiKeyPrimaryBtn" class="modal-ok">Save</button>
        <button id="apiKeyCancelBtn" class="modal-ok">Cancel</button>
      </div>
    </div>
  </div>
<!-- Tab Rename overlay -->
<div id="tabRenameOverlay" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tabRenameTitle">
  <div class="modal-content modal-sm" role="document">
    <div class="modal-header">
      <h2 id="tabRenameTitle">Rename tab</h2>
      <button id="tabRenameCloseBtn" class="modal-close" aria-label="Close rename dialog">Ã—</button>
    </div>

    <div class="modal-body">
      <label for="tabRenameInput">Tab name</label>
      <input type="text" id="tabRenameInput" placeholder="e.g. auth.js patch" autocomplete="off">
      <div class="modal-hint">Press Enter to save</div>
    </div>

    <div class="modal-footer">
      <button id="tabRenameSaveBtn" class="modal-ok">Save</button>
      <button id="tabRenameCancelBtn" class="modal-ok">Cancel</button>
    </div>
  </div>
</div>

  <!-- Tab Close confirmation overlay -->
  <div id="tabCloseOverlay" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="tabCloseTitle">
    <div class="modal-content modal-sm" role="document">
      <div class="modal-header">
        <h2 id="tabCloseTitle">Close tab?</h2>
        <button id="tabCloseCloseBtn" class="modal-close" aria-label="Close close-tab dialog">Ã—</button>
      </div>
 
      <div class="modal-body">
        <p>
          Close <b id="tabCloseName">this tab</b>? Any unsaved input in this tab will be lost.
        </p>
      </div>
 
      <div class="modal-footer">
        <button id="tabCloseConfirmBtn" class="modal-ok">Close tab</button>
        <button id="tabCloseCancelBtn" class="modal-ok">Cancel</button>
      </div>
    </div>
  </div>
 
  <script src="renderer.js"></script>
</body>
</html>